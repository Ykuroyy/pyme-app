<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ tool.title }} - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿè¡Œ - Pythonã§ã§ãã‚‹ãƒ“ã‚¸ãƒã‚¹è‡ªå‹•åŒ–</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .step-box { background: white; padding: 20px; border-radius: 10px; margin: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .CodeMirror { height: 300px; border: 1px solid #ddd; border-radius: 5px; }
        .result-box { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
        .loading { display: none; }
        .btn-execute { margin-top: 10px; }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <a href="/" class="btn btn-outline-secondary mb-4">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
            
            <div class="mb-3 d-flex align-items-center">
                <span class="badge bg-secondary me-2">{{ tool.category }}</span>
                <span class="badge bg-primary">{{ tool.id }}</span>
            </div>
            <h1 class="mb-4">ğŸ¤– {{ tool.title }} - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿè¡Œ</h1>
            <p class="lead">{{ tool.desc }}</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ› -->
            <div class="step-box">
                <h3>ğŸ“ ã‚¹ãƒ†ãƒƒãƒ—1: AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¢ºèªãƒ»ç·¨é›†</h3>
                <div class="mt-3">
                    <div class="alert alert-info">
                        <strong>è‡ªå‹•ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼š</strong>
                        <p class="mb-2">ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    
                    <textarea id="promptInput" class="form-control" rows="8" placeholder="AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...">{{ tool.ai_prompt or '' }}</textarea>
                    
                    <div class="mt-3">
                        <button id="generateBtn" class="btn btn-primary btn-execute">
                            <span class="spinner-border spinner-border-sm loading" role="status"></span>
                            ğŸ¤– AIã«ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’ä¾é ¼
                        </button>
                    </div>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—2: è¨­å®šå…¥åŠ› -->
            <div class="step-box">
                <h3>âš™ï¸ ã‚¹ãƒ†ãƒƒãƒ—2: è¨­å®šã‚’å…¥åŠ›</h3>
                <div class="mt-3">
                    <div class="alert alert-warning">
                        <strong>æ³¨æ„ï¼š</strong>
                        <p class="mb-2">å®Ÿéš›ã®ä½¿ç”¨æ™‚ã¯ã€ä»¥ä¸‹ã®è¨­å®šã‚’è‡ªåˆ†ã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    
                    <div id="configForm">
                        <!-- å‹•çš„ã«è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç”Ÿæˆã•ã‚Œã‚‹ -->
                    </div>
                    
                    <div class="mt-3">
                        <button id="saveConfigBtn" class="btn btn-success">
                            ğŸ’¾ è¨­å®šã‚’ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºãƒ»å®Ÿè¡Œ -->
            <div class="step-box">
                <h3>ğŸ’» ã‚¹ãƒ†ãƒƒãƒ—3: ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰</h3>
                <div class="mt-3">
                    <div id="codeContainer">
                        <div class="alert alert-secondary">
                            <strong>ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå¾…ã¡ï¼š</strong>
                            <p class="mb-0">å·¦å´ã®ã€ŒAIã«ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’ä¾é ¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button id="executeBtn" class="btn btn-success btn-execute" disabled>
                            <span class="spinner-border spinner-border-sm loading" role="status"></span>
                            â–¶ï¸ ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
                        </button>
                        <button id="downloadBtn" class="btn btn-outline-primary btn-execute" disabled>
                            ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>
                    </div>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—4: å®Ÿè¡Œçµæœ -->
            <div class="step-box">
                <h3>ğŸ“Š ã‚¹ãƒ†ãƒƒãƒ—4: å®Ÿè¡Œçµæœ</h3>
                <div class="mt-3">
                    <div id="resultContainer">
                        <div class="alert alert-info">
                            <strong>å®Ÿè¡Œçµæœï¼š</strong>
                            <p class="mb-0">ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script>
let codeEditor = null;
let generatedCode = '';

// è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‹•çš„ã«ç”Ÿæˆ
function generateConfigFields() {
    const configForm = document.getElementById('configForm');
    const toolId = {{ tool.id }};
    
    // ãƒ„ãƒ¼ãƒ«åˆ¥ã®è¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    const configs = {
        1: [ // ãƒ¡ãƒ¼ãƒ«è‡ªå‹•é€ä¿¡
            { name: 'sender_email', label: 'é€ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', type: 'email', placeholder: 'your_email@gmail.com' },
            { name: 'receiver_email', label: 'å—ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', type: 'email', placeholder: 'receiver@example.com' },
            { name: 'subject', label: 'ä»¶å', type: 'text', placeholder: 'è‡ªå‹•é€ä¿¡ãƒ¡ãƒ¼ãƒ«' },
            { name: 'message', label: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', type: 'textarea', placeholder: 'ã“ã‚Œã¯è‡ªå‹•é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚' }
        ],
        2: [ // Excelè‡ªå‹•å‡¦ç†
            { name: 'input_file', label: 'å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«å', type: 'text', placeholder: 'data.xlsx' },
            { name: 'output_file', label: 'å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å', type: 'text', placeholder: 'result.xlsx' },
            { name: 'target_column', label: 'é›†è¨ˆå¯¾è±¡åˆ—', type: 'text', placeholder: 'å£²ä¸Š' }
        ],
        6: [ // ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•æ•´ç†
            { name: 'folder_path', label: 'æ•´ç†å¯¾è±¡ãƒ•ã‚©ãƒ«ãƒ€', type: 'text', placeholder: 'C:/Users/YourName/Downloads' }
        ]
    };
    
    const fields = configs[toolId] || [
        { name: 'custom_setting', label: 'ã‚«ã‚¹ã‚¿ãƒ è¨­å®š', type: 'text', placeholder: 'è¨­å®šå€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' }
    ];
    
    configForm.innerHTML = fields.map(field => `
        <div class="mb-3">
            <label for="${field.name}" class="form-label">${field.label}</label>
            ${field.type === 'textarea' 
                ? `<textarea id="${field.name}" class="form-control" placeholder="${field.placeholder}"></textarea>`
                : `<input type="${field.type}" id="${field.name}" class="form-control" placeholder="${field.placeholder}">`
            }
        </div>
    `).join('');
}

// ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
document.getElementById('generateBtn').addEventListener('click', async function() {
    const btn = this;
    const prompt = document.getElementById('promptInput').value;
    
    if (!prompt.trim()) {
        alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    btn.disabled = true;
    btn.querySelector('.loading').style.display = 'inline-block';
    
    try {
        const response = await fetch('/api/generate-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tool_id: {{ tool.id }},
                custom_prompt: prompt
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            generatedCode = data.code;
            
            // CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ã‚’åˆæœŸåŒ–
            if (codeEditor) {
                codeEditor.setValue(generatedCode);
            } else {
                const textarea = document.createElement('textarea');
                textarea.id = 'codeEditor';
                document.getElementById('codeContainer').innerHTML = '';
                document.getElementById('codeContainer').appendChild(textarea);
                
                codeEditor = CodeMirror.fromTextArea(textarea, {
                    mode: 'python',
                    theme: 'monokai',
                    lineNumbers: true,
                    readOnly: false
                });
                codeEditor.setValue(generatedCode);
            }
            
            document.getElementById('executeBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
            
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
        }
        
    } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.querySelector('.loading').style.display = 'none';
    }
});

// ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ
document.getElementById('executeBtn').addEventListener('click', async function() {
    const btn = this;
    const code = codeEditor ? codeEditor.getValue() : generatedCode;
    
    if (!code.trim()) {
        alert('å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
    }
    
    btn.disabled = true;
    btn.querySelector('.loading').style.display = 'inline-block';
    
    try {
        const response = await fetch('/api/execute-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tool_id: {{ tool.id }},
                code: code
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            let resultHtml = '<div class="alert alert-success"><strong>âœ… å®Ÿè¡ŒæˆåŠŸï¼</strong></div>';
            
            if (data.stdout) {
                resultHtml += `<div class="result-box"><strong>å‡ºåŠ›:</strong><br>${data.stdout.replace(/\n/g, '<br>')}</div>`;
            }
            
            if (data.stderr) {
                resultHtml += `<div class="result-box text-danger"><strong>ã‚¨ãƒ©ãƒ¼:</strong><br>${data.stderr.replace(/\n/g, '<br>')}</div>`;
            }
            
            document.getElementById('resultContainer').innerHTML = resultHtml;
            
        } else {
            let errorMessage = data.error;
            if (data.error.includes('Security:')) {
                errorMessage = 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã§ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯Webå®Ÿè¡Œç’°å¢ƒã§ã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
            } else if (data.error.includes('timed out')) {
                errorMessage = 'ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡ŒãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚„é•·æ™‚é–“ã®å‡¦ç†ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
            }
            document.getElementById('resultContainer').innerHTML = 
                `<div class="alert alert-danger"><strong>âŒ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:</strong><br>${errorMessage}</div>`;
        }
        
    } catch (error) {
        document.getElementById('resultContainer').innerHTML = 
            `<div class="alert alert-danger"><strong>âŒ ã‚¨ãƒ©ãƒ¼:</strong><br>${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.querySelector('.loading').style.display = 'none';
    }
});

// ã‚³ãƒ¼ãƒ‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
document.getElementById('downloadBtn').addEventListener('click', function() {
    const code = codeEditor ? codeEditor.getValue() : generatedCode;
    
    if (!code.trim()) {
        alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
    }
    
    const blob = new Blob([code], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ tool.title }}_code.py';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

// è¨­å®šä¿å­˜
document.getElementById('saveConfigBtn').addEventListener('click', async function() {
    const configData = {};
    const configForm = document.getElementById('configForm');
    const inputs = configForm.querySelectorAll('input, textarea');
    
    inputs.forEach(input => {
        configData[input.id] = input.value;
    });
    
    try {
        const response = await fetch('/api/save-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tool_id: {{ tool.id }},
                config: configData
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
        }
        
    } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
});

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    generateConfigFields();
});
</script>
</body>
</html> 